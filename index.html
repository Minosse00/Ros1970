<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gestione Spese Auto Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212; --bg-light: #f8f9fa;
            --card-dark: #1e1e1e; --card-light: #ffffff;
            --text-dark: #e0e0e0; --text-light: #212529;
            --accent: #4CAF50; --danger: #ef5350;
            --warning: #ffca28; --info: #42a5f5;
            --purple: #ab47bc; --secondary: #78909c;
        }

        body { 
            font-family: 'Segoe UI', system-ui, -apple-system, sans-serif; 
            background-color: var(--bg-dark); color: var(--text-dark); 
            margin: 0; padding: 0; transition: background 0.3s;
            -webkit-tap-highlight-color: transparent;
        }
        body.light-theme { background-color: var(--bg-light); color: var(--text-light); }

        header { 
            padding: 20px; text-align: center; font-size: 1.4rem; font-weight: 800; 
            background: #1a1a1a; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        .light-theme header { background: #fff; color: #333; }

        .container { width: 94%; max-width: 800px; margin: 15px auto; padding-bottom: 50px; }

        .card { 
            background: var(--card-dark); padding: 15px; border-radius: 16px; 
            margin-bottom: 15px; border: 1px solid rgba(255,255,255,0.08);
        }
        .light-theme .card { background: var(--card-light); border: 1px solid #e0e0e0; }

        .form-grid { display: grid; grid-template-columns: 1fr; gap: 12px; }
        @media (min-width: 600px) { .form-grid { grid-template-columns: 1fr 1fr; } }

        label { display: block; margin-bottom: 5px; font-size: 0.8rem; font-weight: 600; opacity: 0.7; }

        input, select { 
            height: 45px; padding: 0 10px; border-radius: 10px; border: 2px solid #333; 
            background: #2d2d2d; color: white; width: 100%; font-size: 1rem; box-sizing: border-box;
        }
        .light-theme input, .light-theme select { background: #f1f3f5; color: #333; border: 2px solid #dee2e6; }

        /* Pulsanti */
        .btn-list { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px; }
        button { 
            height: 48px; border: none; border-radius: 12px; cursor: pointer; 
            display: flex; align-items: center; justify-content: center;
            gap: 8px; font-weight: bold; font-size: 0.9rem; transition: 0.2s;
        }
        button:active { transform: scale(0.95); }
        .full-width { grid-column: span 2; }

        .accent { background: var(--accent); color: white; }
        .info { background: var(--info); color: white; }
        .danger { background: var(--danger); color: white; }
        .warning { background: var(--warning); color: #222; }
        .secondary { background: var(--secondary); color: white; }
        .purple { background: var(--purple); color: white; }

        /* Riepilogo */
        .summary-box { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .summary-item { padding: 12px; border-radius: 10px; background: rgba(255,255,255,0.05); text-align: center; }
        .summary-item.total { grid-column: span 2; border-top: 2px solid var(--info); font-size: 1.1rem; }

        .green { color: var(--accent); }
        .red { color: var(--danger); }

        /* Tabelle Mobile */
        .table-scroll { overflow-x: auto; border-radius: 10px; background: rgba(0,0,0,0.2); }
        table { width: 100%; border-collapse: collapse; font-size: 0.85rem; }
        th, td { padding: 12px 8px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }

        .theme-toggle { position: absolute; top: 15px; right: 15px; width: 40px; height: 40px; border-radius: 50%; }
    </style>
</head>
<body onload="inizializza()">

    <header>Gestione Auto</header>
    <button class="theme-toggle warning" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>

    <div class="container">
        <div class="card">
            <div class="form-grid">
                <div><label>Data</label><input type="date" id="data"></div>
                <div><label>Entrate (€)</label><input type="number" id="entrate" inputmode="decimal"></div>
                <div><label>Uscite (€)</label><input type="number" id="uscite" inputmode="decimal"></div>
                <div>
                    <label>Nota</label>
                    <select id="note-select" onchange="checkAltro()">
                        <option value="">Seleziona...</option>
                        <option value="Ferma">Ferma</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Pedaggio">Pedaggio</option>
                        <option value="Telepass">Telepass</option>
                        <option value="Altro">Altro...</option>
                    </select>
                    <input type="text" id="altra-nota" style="display:none; margin-top:8px" placeholder="Specifica...">
                </div>
            </div>
            <button class="accent full-width" style="margin-top:15px;" onclick="aggiungiRecord()"><i class="fa-solid fa-plus"></i> AGGIUNGI ORA</button>
        </div>

        <div class="card summary-box">
            <div class="summary-item">E: <span class="green" id="sum-entrate-main">0€</span></div>
            <div class="summary-item">U: <span class="red" id="sum-uscite-main">0€</span></div>
            <div class="summary-item total" id="sum-fondo-main">FONDO: <strong>0.00 €</strong></div>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-magnifying-glass"></i> Ricerca e Report</label>
            <div class="form-grid">
                <div><label>Settimana</label><input type="date" id="search-week"></div>
                <div><label>Mese (MM/YYYY)</label><input type="text" id="search-month" placeholder="01/2026"></div>
                <div class="full-width"><label>Periodo 15 - 16 succ. (MM/YYYY)</label><input type="text" id="search-15-16" placeholder="01/2026"></div>
            </div>
            
            <div class="btn-list">
                <button class="info" onclick="eseguiRicerca('week')">Settimana</button>
                <button class="info" onclick="eseguiRicerca('month')">Mese</button>
                <button class="info full-width" onclick="eseguiRicerca('15-16')">Filtra Periodo 15 - 16</button>
                <button class="secondary" onclick="resetFiltri()">Reset</button>
                <button class="danger" onclick="generaPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
            </div>
        </div>

        <div id="risultati-container" style="display:none" class="card">
            <h4 id="titolo-ricerca" style="margin:0 0 10px 0; color:var(--info);"></h4>
            <div class="table-scroll">
                <table id="search-table">
                    <thead><tr><th>Data</th><th>E</th><th>U</th><th>Nota</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="search-summary" style="margin-top:10px; padding:10px; background:rgba(0,0,0,0.2); border-radius:8px; font-size:0.85rem;"></div>
        </div>

        <div class="btn-list">
            <button class="purple" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-upload"></i> Importa</button>
            <button class="purple" onclick="esportaBackupJSON()"><i class="fa-solid fa-download"></i> Backup</button>
            <input type="file" id="file-input" style="display:none" accept=".json" onchange="importaBackupJSON(event)">
        </div>

        <button class="secondary full-width" style="margin-top:15px" onclick="toggleVisibilita('storico-container')">Mostra Storico Completo</button>
        <div id="storico-container" style="display:none" class="table-scroll card">
            <table id="storico-table">
                <thead><tr><th>Data</th><th>E</th><th>U</th><th>X</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>
    </div>

    <script>
        let databaseLocale = JSON.parse(localStorage.getItem('db_spese_locale')) || [];
        let datiFiltrati = [];
        let etichettaFiltro = "";
        let saldoPrecedente = 0;

        function inizializza() {
            document.getElementById("data").valueAsDate = new Date();
            aggiornaTabella();
        }

        function salvaEAggiorna() {
            localStorage.setItem('db_spese_locale', JSON.stringify(databaseLocale));
            aggiornaTabella();
        }

        function aggiungiRecord() {
            const d = document.getElementById("data").value;
            const e = parseFloat(document.getElementById("entrate").value) || 0;
            const u = parseFloat(document.getElementById("uscite").value) || 0;
            const n = document.getElementById("note-select").value;
            const nota = n === "Altro" ? document.getElementById("altra-nota").value : n;

            if(!d) return alert("Manca la data!");
            if(n !== "Ferma" && e === 0 && u === 0) return alert("Inserisci un importo!");

            databaseLocale.push({ id: Date.now(), data: d, entrate: e, uscite: u, note: nota || "-" });
            salvaEAggiorna();
            resetForm();
        }

        function aggiornaTabella() {
            const tbody = document.querySelector("#storico-table tbody");
            tbody.innerHTML = "";
            let eT = 0, uT = 0;
            databaseLocale.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(item => {
                eT += item.entrate; uT += item.uscite;
                tbody.innerHTML += `<tr><td>${item.data.split('-').reverse().slice(0,2).join('/')}</td><td class="green">${item.entrate}</td><td class="red">${item.uscite}</td><td><i class="fa-solid fa-trash red" onclick="elimina(${item.id})"></i></td></tr>`;
            });
            document.getElementById("sum-entrate-main").innerText = eT.toFixed(2) + "€";
            document.getElementById("sum-uscite-main").innerText = uT.toFixed(2) + "€";
            document.getElementById("sum-fondo-main").innerHTML = `FONDO: <strong>${(eT - uT).toFixed(2)} €</strong>`;
        }

        function eseguiRicerca(tipo) {
            const sw = document.getElementById("search-week").value;
            const sm = document.getElementById("search-month").value;
            const sp = document.getElementById("search-15-16").value;
            let inizio, fine;

            if(tipo === 'week' && sw) {
                let d = new Date(sw);
                let day = d.getDay() || 7;
                inizio = new Date(d); inizio.setDate(d.getDate() - day + 1);
                fine = new Date(inizio); fine.setDate(inizio.getDate() + 6);
                etichettaFiltro = `Settimana ${inizio.toLocaleDateString()}`;
            } else if(tipo === 'month' && sm) {
                let p = sm.split("/");
                inizio = new Date(p[1], p[0]-1, 1);
                fine = new Date(p[1], p[0], 0);
                etichettaFiltro = `Mese ${sm}`;
            } else if(tipo === '15-16' && sp) {
                let p = sp.split("/");
                inizio = new Date(p[1], p[0]-1, 15);
                fine = new Date(p[1], p[0], 16);
                etichettaFiltro = `Dal 15/${p[0]} al 16/${parseInt(p[0]) == 12 ? '01' : String(parseInt(p[0])+1).padStart(2,'0')}`;
            } else { return alert("Inserisci il valore per filtrare!"); }

            datiFiltrati = databaseLocale.filter(x => {
                let d = new Date(x.data);
                return d >= inizio && d <= fine;
            }).sort((a,b) => new Date(a.data) - new Date(b.data));

            saldoPrecedente = databaseLocale.filter(x => new Date(x.data) < inizio).reduce((a,b) => a + (b.entrate - b.uscite), 0);
            
            mostraRisultati();
        }

        function mostraRisultati() {
            const tbody = document.querySelector("#search-table tbody");
            tbody.innerHTML = "";
            let e = 0, u = 0;
            datiFiltrati.forEach(i => {
                e += i.entrate; u += i.uscite;
                tbody.innerHTML += `<tr><td>${i.data.split('-').reverse().slice(0,2).join('/')}</td><td class="green">${i.entrate}</td><td class="red">${i.uscite}</td><td>${i.note}</td></tr>`;
            });
            document.getElementById("titolo-ricerca").innerText = etichettaFiltro;
            document.getElementById("search-summary").innerHTML = `Saldo Prec: ${saldoPrecedente.toFixed(2)}€ | Fondo Tot: <b>${(saldoPrecedente + e - u).toFixed(2)}€</b>`;
            document.getElementById("risultati-container").style.display = "block";
        }

        function elimina(id) { if(confirm("Eliminare?")) { databaseLocale = databaseLocale.filter(d => d.id !== id); salvaEAggiorna(); } }
        function toggleTheme() { document.body.classList.toggle("light-theme"); }
        function checkAltro() { document.getElementById("altra-nota").style.display = document.getElementById("note-select").value === "Altro" ? "block" : "none"; }
        function toggleVisibilita(id) { let e = document.getElementById(id); e.style.display = e.style.display === "none" ? "block" : "none"; }
        function resetForm() { document.getElementById("entrate").value = ""; document.getElementById("uscite").value = ""; document.getElementById("note-select").value = ""; document.getElementById("altra-nota").style.display = "none"; }
        function resetFiltri() { document.getElementById("risultati-container").style.display = "none"; }
        
        function esportaBackupJSON() {
            const a = document.createElement('a');
            a.href = URL.createObjectURL(new Blob([JSON.stringify(databaseLocale, null, 2)], {type: "application/json"}));
            a.download = "backup_spese.json"; a.click();
        }

        function importaBackupJSON(event) {
            const reader = new FileReader();
            reader.onload = (e) => { databaseLocale = JSON.parse(e.target.result); salvaEAggiorna(); };
            reader.readAsText(event.target.files[0]);
        }

        function generaPDF() {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Report: " + etichettaFiltro, 14, 15);
            const r = datiFiltrati.map(i => [i.data, i.entrate, i.uscite, i.note]);
            doc.autoTable({ head: [['Data', 'Entrata', 'Uscita', 'Nota']], body: r, startY: 20 });
            doc.save("Report.pdf");
        }
    </script>
</body>
</html>
