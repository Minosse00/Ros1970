<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestione Spese con Firebase</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-database.js"></script>
    <style>
        :root {
            --bg-dark: #1e1e1e;
            --bg-light: #ffffff;
            --text-dark: #f5f5f5;
            --text-light: #222222;
            --accent: #4CAF50;
            --danger: #f44336;
        }
        body {
            font-family: Arial, sans-serif;
            background-color: var(--bg-dark);
            color: var(--text-dark);
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }
        .light-theme {
            background-color: var(--bg-light);
            color: var(--text-light);
        }
        header {
            padding: 1rem;
            font-size: 1.5rem;
            font-weight: bold;
            text-align: center;
            width: 100%;
        }
        .container {
            width: 95%;
            max-width: 1200px;
        }
        .form-section {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            margin-bottom: 20px;
            align-items: flex-end;
        }
        .form-section > div {
            display: flex;
            flex-direction: column;
            align-items: flex-start;
            flex: 1;
            min-width: 150px;
        }
        .form-section label {
            font-size: 0.9rem;
            margin-bottom: 5px;
        }
        input[type="date"],
        input[type="number"],
        input[type="text"],
        select {
            padding: 8px;
            font-size: 1rem;
            width: 100%;
            box-sizing: border-box;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 10px;
        }
        th,
        td {
            border: 1px solid #ccc;
            padding: 8px;
            text-align: center;
        }
        tr:nth-child(even) {
            background-color: rgba(255, 255, 255, 0.03);
        }
        .button-group {
            display: flex;
            flex-wrap: wrap;
            gap: 150px;
        }
        button {
            border: none;
            cursor: pointer;
            border-radius: 6px;
            padding: 10px 15px;
            display: flex;
            align-items: center;
            gap: 8px;
        }
        .accent {
            background-color: var(--accent);
            color: #fff;
        }
        .danger {
            background-color: var(--danger);
            color: #fff;
        }
        .warning {
            background-color: #FFC107;
            color: #222;
        }
        .info {
            background-color: #2196F3;
            color: #fff;
        }
        .theme-toggle {
            position: absolute;
            top: 10px;
            right: 10px;
            background: none;
            color: inherit;
            font-size: 1.2rem;
            border: none;
            cursor: pointer;
        }
        .green {
            color: var(--accent);
            font-weight: bold;
        }
        .red {
            color: var(--danger);
            font-weight: bold;
        }
        .summary {
            margin-top: 15px;
            padding: 10px;
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.03);
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            justify-content: flex-start;
            font-size: 1.05rem;
        }
        .riepilogo-storico {
            display: flex;
            flex-wrap: wrap;
            gap: 30px; /* Aumentato lo spazio */
            justify-content: flex-start;
            align-items: center;
        }
        .table-scroll {
            overflow-y: auto;
            max-height: 400px;
            overflow-x: auto;
        }
        .glow {
            box-shadow: 0 0 8px 4px #2196F3;
            transition: box-shadow 0.5s ease-in-out;
        }
        @media (max-width: 768px) {
            .form-section {
                flex-direction: column;
                align-items: stretch;
            }
            .form-section > div {
                align-items: stretch;
            }
            table {
                font-size: 0.85rem;
            }
            .button-group, .riepilogo-storico {
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <header>Gestione Spese</header>
    <button class="theme-toggle" onclick="toggleTheme()" title="Cambia tema"><i class="fa-solid fa-moon"></i></button>
    <div class="container">
        <div class="form-section">
            <div>
                <label for="data">Data</label>
                <input type="date" id="data" />
            </div>
            <div>
                <label for="entrate">Entrate</label>
                <input type="number" id="entrate" value="0" step="0.01" min="0" />
            </div>
            <div>
                <label for="uscite">Uscite</label>
                <input type="number" id="uscite" value="0" step="0.01" min="0" />
            </div>
            <div>
                <label for="note">Note</label>
                <select id="note-select" onchange="toggleAltraNota()">
                    <option value="">Seleziona una nota...</option>
                    <option value="Diesel">Diesel</option>
                    <option value="Pedaggio Autostradale">Pedaggio Autostradale</option>
                    <option value="Canone Telepass">Canone Telepass</option>
                    <option value="Altro">Altro</option>
                </select>
                <input type="text" id="altra-nota" style="display: none; margin-top: 5px" placeholder="Inserisci altra nota" />
            </div>
            <div style="flex-grow: 0;">
                <button class="accent" onclick="aggiungiVoce()"><i class="fa-solid fa-plus"></i> Aggiungi Dati</button>
            </div>
        </div>
        <div class="button-group" style="margin-bottom: 20px;">
            <button class="accent" onclick="salvaDatiOnline()"><i class="fa-solid fa-cloud-upload-alt"></i> Salva su Firebase</button>
            <button class="info" onclick="caricaDatiOnline()"><i class="fa-solid fa-cloud-download-alt"></i> Carica da Firebase</button>
        </div>
        <hr style="border-top: 1px solid #ccc; margin: 20px 0" />
        <div class="summary riepilogo-storico" id="summary-main">
            <span class="green" id="sum-entrate-main">Entrate: 0</span>
            <span class="red" id="sum-uscite-main">Uscite: 0</span>
            <span id="sum-fondo-main">Fondo Cassa Attuale: 0</span>
            <div id="date-range-main" style="margin-left: auto;">
                Periodo: dal ... al ...
            </div>
        </div>
        <button onclick="toggleStorico()" class="warning"><i class="fa-solid fa-eye"></i> Mostra Storico</button>
        <div id="storico-container">
            <div class="table-scroll">
                <table id="storico-table">
                    <thead>
                        <tr>
                            <th>Data</th>
                            <th>Entrate</th>
                            <th>Uscite</th>
                            <th>Note</th>
                            <th>Azioni</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>
        <hr style="border-top: 1px solid #ccc; margin: 20px 0" />
        <div class="search-section">
            <h3>Ricerca e Gestione Dati</h3>
            <div class="form-section">
                <div>
                    <label for="search-week-date">Data (per settimana)</label>
                    <input type="date" id="search-week-date" />
                </div>
                <div>
                    <label for="search-month">Mese/Anno (MM/YYYY)</label>
                    <input type="text" id="search-month" placeholder="MM/YYYY" />
                </div>
                <div>
                    <button class="info" onclick="cercaDatiFiltrati()">Cerca</button>
                    <button class="warning" onclick="pulisciRisultati()">Pulisci Risultati</button>
                </div>
            </div>
            <div class="button-group" style="margin-top: 12px; justify-content: flex-start">
                <button class="danger" onclick="esportaPDF('settimana')"><i class="fa-solid fa-file-pdf"></i> Esporta Settimana (PDF)</button>
                <button class="danger" onclick="esportaPDF('mese')"><i class="fa-solid fa-file-pdf"></i> Esporta Mese (PDF)</button>
                <button class="accent" onclick="esportaExcel('settimana')"><i class="fa-solid fa-file-excel"></i> Esporta Settimana (XLSX)</button>
                <button class="accent" onclick="esportaExcel('mese')"><i class="fa-solid fa-file-excel"></i> Esporta Mese (XLSX)</button>
            </div>
            <div id="risultati-ricerca" style="display: none; margin-top: 20px">
                <h4>Risultati Trovati</h4>
                <div class="table-scroll">
                    <table id="search-results-table">
                        <thead>
                            <tr>
                                <th>Seleziona</th>
                                <th>Data</th>
                                <th>Entrate</th>
                                <th>Uscite</th>
                                <th>Note</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
                <div class="summary" id="search-summary">
                    <span class="green" id="search-sum-entrate">Entrate: 0</span>
                    <span class="red" id="search-sum-uscite">Uscite: 0</span>
                    <span id="search-sum-fondo">Fondo Cassa Attuale: 0</span>
                </div>
                <div style="margin-top: 12px">
                    <button class="danger" onclick="cancellaDatiSelezionati()">Cancella Voci Selezionate</button>
                </div>
            </div>
        </div>
    </div>
    <script>
        let storicoDati = [];
        const firebaseConfig = {
            apiKey: "AIzaSyCKf4B5Sr4chHiUw3xlfumk3Qzj7zF581U",
            authDomain: "gestione-spese-9a9fd.firebaseapp.com",
            databaseURL: "https://gestione-spese-9a9fd-default-rtdb.firebaseio.com/",
            projectId: "gestione-spese-9a9fd",
            storageBucket: "gestione-spese-9a9fd.firebasestorage.app",
            messagingSenderId: "542317208533",
            appId: "1:542317208533:web:947f32ccddb4e5ed2c535c",
        };
        if (!firebase.apps.length) {
            firebase.initializeApp(firebaseConfig);
        }
        const database = firebase.database();
        const dbRef = database.ref("/spese");
        document.addEventListener("DOMContentLoaded", () => {
            caricaDatiOnline();
            const storicoContainer = document.getElementById("storico-container");
            const toggleButton = document.querySelector('button[onclick="toggleStorico()"]');
            storicoContainer.style.display = "none";
            toggleButton.innerHTML = '<i class="fa-solid fa-eye"></i> Mostra Storico';
            const dataInput = document.getElementById("data");
            if (dataInput) {
                dataInput.valueAsDate = new Date();
            }
        });
        async function salvaDatiOnline() {
            try {
                await dbRef.set(storicoDati);
                alert("Dati salvati su Firebase con successo!");
            } catch (error) {
                console.error("Errore nel salvataggio su Firebase:", error);
                alert("Si è verificato un errore durante il salvataggio su Firebase.");
            }
        }
        async function caricaDatiOnline() {
            const btn = document.querySelector('button.info');
            btn.classList.add('glow');
            try {
                const snapshot = await dbRef.once("value");
                const data = snapshot.val();
                if (data) {
                    storicoDati = data;
                } else {
                    storicoDati = [];
                }
                ricaricaTabellaPrincipale();
                aggiornaRiepilogo();
            } catch (error) {
                console.error("Errore nel caricamento da Firebase:", error);
                alert("Si è verificato un errore durante il caricamento da Firebase.");
            } finally {
                setTimeout(() => {
                    btn.classList.remove('glow');
                }, 1000);
            }
        }
        function toggleTheme() {
            document.body.classList.toggle("light-theme");
            const icon = document.querySelector(".theme-toggle i");
            icon.className = document.body.classList.contains("light-theme") ? "fa-solid fa-sun" : "fa-solid fa-moon";
        }
        function toggleStorico() {
            const c = document.getElementById("storico-container");
            const btn = document.querySelector('button[onclick="toggleStorico()"]');
            if (c.style.display === "none") {
                c.style.display = "block";
                btn.innerHTML = '<i class="fa-solid fa-eye-slash"></i> Nascondi Storico';
            } else {
                c.style.display = "none";
                btn.innerHTML = '<i class="fa-solid fa-eye"></i> Mostra Storico';
            }
        }
        function formatData(dateString) {
            const data = new Date(dateString);
            const giorno = data.getDate().toString().padStart(2, "0");
            const mese = (data.getMonth() + 1).toString().padStart(2, "0");
            const anno = data.getFullYear();
            return `${giorno}-${mese}-${anno}`;
        }
        function parseData(dateString) {
            const [giorno, mese, anno] = dateString.split('-');
            return new Date(`${anno}-${mese}-${giorno}`);
        }
        function toggleAltraNota() {
            const noteSelect = document.getElementById("note-select");
            const altraNotaInput = document.getElementById("altra-nota");
            if (noteSelect.value === "Altro") {
                altraNotaInput.style.display = "block";
            } else {
                altraNotaInput.style.display = "none";
            }
        }
        function aggiungiVoce() {
            const dataVal = document.getElementById("data").value;
            const entrateVal = parseFloat(document.getElementById("entrate").value);
            const usciteVal = parseFloat(document.getElementById("uscite").value);
            const noteSelectVal = document.getElementById("note-select").value;
            let noteVal = "";
            if (noteSelectVal === "Altro") {
                noteVal = document.getElementById("altra-nota").value || "-";
            } else {
                noteVal = noteSelectVal || "-";
            }
            if (!dataVal || isNaN(entrateVal) || isNaN(usciteVal) || (entrateVal <= 0 && usciteVal <= 0)) {
                alert("Per favore, inserisci una data e almeno un valore valido per entrate o uscite.");
                return;
            }
            const nuovaVoce = {
                data: formatData(dataVal),
                entrate: entrateVal,
                uscite: usciteVal,
                note: noteVal,
            };
            storicoDati.push(nuovaVoce);
            salvaDatiOnline();
            ricaricaTabellaPrincipale();
            document.getElementById("data").value = "";
            document.getElementById("entrate").value = "0";
            document.getElementById("uscite").value = "0";
            document.getElementById("note-select").value = "";
            document.getElementById("altra-nota").value = "";
            document.getElementById("altra-nota").style.display = "none";
            aggiornaRiepilogo();
        }
        function rimuoviVoce(index) {
            if (confirm("Sei sicuro di voler rimuovere questa voce?")) {
                storicoDati.splice(index, 1);
                salvaDatiOnline();
                ricaricaTabellaPrincipale();
                aggiornaRiepilogo();
            }
        }
        function modificaVoce(index) {
            const itemToModify = storicoDati[index];
            const dataParts = itemToModify.data.split("-");
            const formattedDate = `${dataParts[2]}-${dataParts[1]}-${dataParts[0]}`;
            document.getElementById("data").value = formattedDate;
            document.getElementById("entrate").value = itemToModify.entrate;
            document.getElementById("uscite").value = itemToModify.uscite;
            const noteSelect = document.getElementById("note-select");
            const altraNotaInput = document.getElementById("altra-nota");
            let isDefaultOption = false;
            for (let i = 0; i < noteSelect.options.length; i++) {
                if (noteSelect.options[i].value === itemToModify.note) {
                    noteSelect.value = itemToModify.note;
                    altraNotaInput.style.display = "none";
                    isDefaultOption = true;
                    break;
                }
            }
            if (!isDefaultOption) {
                noteSelect.value = "Altro";
                altraNotaInput.value = itemToModify.note;
                altraNotaInput.style.display = "block";
            }
            storicoDati.splice(index, 1);
            salvaDatiOnline();
            ricaricaTabellaPrincipale();
            aggiornaRiepilogo();
        }
        function aggiornaRiepilogo() {
            let entrateTot = 0, usciteTot = 0;
            let primoInserimento = "N/A", ultimoInserimento = "N/A";
            
            if (storicoDati.length > 0) {
                const datiOrdinati = [...storicoDati].sort((a, b) => parseData(a.data) - parseData(b.data));
                primoInserimento = datiOrdinati[0].data;
                ultimoInserimento = datiOrdinati[datiOrdinati.length - 1].data;
                
                storicoDati.forEach((item) => {
                    entrateTot += item.entrate;
                    usciteTot += item.uscite;
                });
            }
            
            document.getElementById("sum-entrate-main").textContent = `Entrate: ${entrateTot.toFixed(2)}`;
            document.getElementById("sum-uscite-main").textContent = `Uscite: ${usciteTot.toFixed(2)}`;
            document.getElementById("sum-fondo-main").textContent = `Fondo Cassa Attuale: ${(entrateTot - usciteTot).toFixed(2)}`;
            document.getElementById("date-range-main").textContent = `Periodo: dal ${primoInserimento} al ${ultimoInserimento}`;
        }
        function ricaricaTabellaPrincipale() {
            const tableBody = document.getElementById("storico-table").querySelector("tbody");
            tableBody.innerHTML = "";
            const datiOrdinati = [...storicoDati];
            datiOrdinati.sort((a, b) => {
                const dataA = a.data.split('-').reverse().join('-');
                const dataB = b.data.split('-').reverse().join('-');
                return new Date(dataB) - new Date(dataA);
            });
            datiOrdinati.forEach((item, index) => {
                const originalIndex = storicoDati.findIndex(d =>
                    d.data === item.data &&
                    d.entrate === item.entrate &&
                    d.uscite === item.uscite &&
                    d.note === item.note
                );
                const newRow = tableBody.insertRow();
                newRow.innerHTML = `
                    <td>${item.data}</td>
                    <td class="green">${item.entrate.toFixed(2)}</td>
                    <td class="red">${item.uscite.toFixed(2)}</td>
                    <td>${item.note}</td>
                    <td>
                        <button class="accent" onclick="modificaVoce(${originalIndex})">Modifica</button>
                        <button class="danger" onclick="rimuoviVoce(${originalIndex})">Rimuovi</button>
                    </td>
                `;
            });
        }
        function esportaPDF(tipo) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const { datiFiltrati, fondoPrecedente } = filtraDatiPerEsportazione(tipo);
            if (datiFiltrati.length === 0) {
                alert("Nessun dato da esportare!");
                return;
            }
            const primaData = datiFiltrati[0].data;
            const ultimaData = datiFiltrati[datiFiltrati.length - 1].data;
            let titolo = "Storico Spese";
            if (tipo === "settimana") {
                const dataFiltro = document.getElementById("search-week-date").value;
                titolo = `Storico Spese - Settimana del ${formatData(dataFiltro)}`;
            } else if (tipo === "mese") {
                const meseAnno = document.getElementById("search-month").value;
                titolo = `Storico Spese - Mese ${meseAnno}`;
            }
            doc.setFontSize(18);
            doc.text(titolo, 14, 20);
            doc.setFontSize(12);
            doc.text(`Periodo: dal ${primaData} al ${ultimaData}`, 14, 30);
            const columns = ["Data", "Entrate", "Uscite", "Note"];
            const data = datiFiltrati.map((row) => [row.data, row.entrate.toFixed(2), row.uscite.toFixed(2), row.note]);
            doc.autoTable({
                head: [columns],
                body: data,
                startY: 40,
                margin: { top: 10 },
                theme: "grid",
                didParseCell: (hookData) => {
                    if (hookData.section === 'body') {
                        if (hookData.column.index === 1) {
                            hookData.cell.styles.textColor = [76, 175, 80]; // Verde
                        } else if (hookData.column.index === 2) {
                            hookData.cell.styles.textColor = [244, 67, 54]; // Rosso
                        }
                    }
                },
            });
            const finalY = doc.lastAutoTable.finalY || 40;
            const entrateTot = datiFiltrati.reduce((sum, item) => sum + item.entrate, 0);
            const usciteTot = datiFiltrati.reduce((sum, item) => sum + item.uscite, 0);
            const fondoCassaPeriodo = entrateTot - usciteTot;
            const fondoTotale = fondoPrecedente + fondoCassaPeriodo;
            doc.setFontSize(12);
            doc.setTextColor(76, 175, 80);
            doc.text(`Entrate: ${entrateTot.toFixed(2)}`, 14, finalY + 15);
            doc.setTextColor(244, 67, 54);
            doc.text(`Uscite: ${usciteTot.toFixed(2)}`, 14, finalY + 22);
            doc.setTextColor(0, 0, 0);
            doc.text(`Fondo Cassa Attuale: ${fondoTotale.toFixed(2)}`, 14, finalY + 29);
            doc.save(`storico_spese_${tipo}.pdf`);
        }
        function esportaExcel(tipo) {
            const { datiFiltrati, fondoPrecedente } = filtraDatiPerEsportazione(tipo);
            if (datiFiltrati.length === 0) {
                alert("Nessun dato da esportare!");
                return;
            }
            const entrateTot = datiFiltrati.reduce((sum, item) => sum + item.entrate, 0);
            const usciteTot = datiFiltrati.reduce((sum, item) => sum + item.uscite, 0);
            const fondoCassaPeriodo = entrateTot - usciteTot;
            const fondoTotale = fondoPrecedente + fondoCassaPeriodo;
            const ws_data = [
                ["Data", "Entrate", "Uscite", "Note"],
                ...datiFiltrati.map((row) => [row.data, parseFloat(row.entrate.toFixed(2)), parseFloat(row.uscite.toFixed(2)), row.note]),
                [],
                ["Riepilogo"],
                ["Entrate Totali:", entrateTot.toFixed(2)],
                ["Uscite Totali:", usciteTot.toFixed(2)],
                ["Fondo Cassa Attuale:", fondoTotale.toFixed(2)],
            ];
            const ws = XLSX.utils.aoa_to_sheet(ws_data);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Storico Spese");
            XLSX.writeFile(wb, `storico_spese_${tipo}.xlsx`);
        }
        function filtraDatiPerEsportazione(tipo) {
            let datiFiltrati = [];
            let fondoPrecedente = 0;
            const dataFiltro = document.getElementById("search-week-date").value;
            const meseFiltro = document.getElementById("search-month").value;
            if (tipo === "settimana" && dataFiltro) {
                const result = filtraDatiConIndicePerSettimana(dataFiltro);
                datiFiltrati = result.datiFiltrati;
                fondoPrecedente = result.fondoPrecedente;
            } else if (tipo === "mese" && meseFiltro) {
                const result = filtraDatiConIndicePerMese(meseFiltro);
                datiFiltrati = result.datiFiltrati;
                fondoPrecedente = result.fondoPrecedente;
            } else {
                return { datiFiltrati: [], fondoPrecedente: 0 };
            }
            return { datiFiltrati, fondoPrecedente };
        }
        function cercaDatiFiltrati() {
            const dataFiltro = document.getElementById("search-week-date").value;
            const meseFiltro = document.getElementById("search-month").value;
            const risultatiContainer = document.getElementById("risultati-ricerca");
            const risultatiTBody = document.getElementById("search-results-table").querySelector("tbody");
            risultatiTBody.innerHTML = "";
            let datiFiltratiConIndice = [];
            let fondoPrecedente = 0;
            if (dataFiltro) {
                const result = filtraDatiConIndicePerSettimana(dataFiltro);
                datiFiltratiConIndice = result.datiFiltrati;
                fondoPrecedente = result.fondoPrecedente;
            } else if (meseFiltro) {
                const result = filtraDatiConIndicePerMese(meseFiltro);
                datiFiltratiConIndice = result.datiFiltrati;
                fondoPrecedente = result.fondoPrecedente;
            } else {
                alert("Inserisci una data per la settimana o un mese/anno per la ricerca.");
                risultatiContainer.style.display = "none";
                return;
            }
            if (datiFiltratiConIndice.length === 0) {
                risultatiTBody.innerHTML = '<tr><td colspan="5">Nessun dato trovato per i criteri di ricerca.</td></tr>';
                aggiornaRiepilogoRicerca(0, 0, fondoPrecedente);
            } else {
                datiFiltratiConIndice.forEach((item) => {
                    const newRow = risultatiTBody.insertRow();
                    newRow.innerHTML = `
                        <td><input type="checkbox" class="seleziona-voce" data-original-index="${item.originalIndex}" /></td>
                        <td>${item.data}</td>
                        <td class="green">${item.entrate.toFixed(2)}</td>
                        <td class="red">${item.uscite.toFixed(2)}</td>
                        <td>${item.note}</td>
                    `;
                });
                const entrateTot = datiFiltratiConIndice.reduce((sum, item) => sum + item.entrate, 0);
                const usciteTot = datiFiltratiConIndice.reduce((sum, item) => sum + item.uscite, 0);
                aggiornaRiepilogoRicerca(entrateTot, usciteTot, fondoPrecedente);
            }
            risultatiContainer.style.display = "block";
        }
        function filtraDatiConIndicePerSettimana(dataFiltro) {
            const datiFiltrati = [];
            if (!dataFiltro) return { datiFiltrati: [], fondoPrecedente: 0 };
            const dataFiltroObj = new Date(dataFiltro + "T00:00:00");
            const giornoSettimana = dataFiltroObj.getDay();
            const diff = dataFiltroObj.getDate() - giornoSettimana + (giornoSettimana === 0 ? -6 : 1);
            const inizioSettimana = new Date(dataFiltroObj.setDate(diff));
            inizioSettimana.setHours(0, 0, 0, 0);
            let fondoPrecedente = 0;
            const datiOrdinati = [...storicoDati].sort((a, b) => {
                const dataA = parseData(a.data);
                const dataB = parseData(b.data);
                return dataA - dataB;
            });
            datiOrdinati.forEach((item, index) => {
                const dataCorrente = parseData(item.data);
                if (dataCorrente < inizioSettimana) {
                    fondoPrecedente += item.entrate - item.uscite;
                }
            });
            storicoDati.forEach((item, index) => {
                const dataCorrente = parseData(item.data);
                if (dataCorrente >= inizioSettimana && dataCorrente <= new Date(inizioSettimana.getTime() + 6 * 24 * 60 * 60 * 1000)) {
                    datiFiltrati.push({ ...item, originalIndex: index });
                }
            });
            return { datiFiltrati, fondoPrecedente };
        }
        function filtraDatiConIndicePerMese(meseFiltro) {
            const [mese, anno] = meseFiltro.split("/");
            if (!mese || !anno) {
                return { datiFiltrati: [], fondoPrecedente: 0 };
            }
            const inizioMese = new Date(anno, mese - 1, 1);
            let fondoPrecedente = 0;
            const datiFiltrati = [];
            const datiOrdinati = [...storicoDati].sort((a, b) => {
                const dataA = parseData(a.data);
                const dataB = parseData(b.data);
                return dataA - dataB;
            });
            datiOrdinati.forEach((item, index) => {
                const dataCorrente = parseData(item.data);
                if (dataCorrente < inizioMese) {
                    fondoPrecedente += item.entrate - item.uscite;
                }
            });
            storicoDati.forEach((item, index) => {
                const dataParts = item.data.split("-");
                if (dataParts[1] == mese && dataParts[2] == anno) {
                    datiFiltrati.push({ ...item, originalIndex: index });
                }
            });
            return { datiFiltrati, fondoPrecedente };
        }
        function aggiornaRiepilogoRicerca(entrate, uscite, fondoPrecedente = 0) {
            const fondoCassaPeriodo = entrate - uscite;
            const fondoTotale = fondoPrecedente + fondoCassaPeriodo;
            document.getElementById("search-sum-entrate").textContent = `Entrate: ${entrate.toFixed(2)}`;
            document.getElementById("search-sum-uscite").textContent = `Uscite: ${uscite.toFixed(2)}`;
            document.getElementById("search-sum-fondo").textContent = `Fondo Cassa Attuale: ${fondoTotale.toFixed(2)}`;
        }
        function cancellaDatiSelezionati() {
            const risultatiTBody = document.getElementById("search-results-table").querySelector("tbody");
            const righeSelezionate = Array.from(risultatiTBody.querySelectorAll("input.seleziona-voce:checked"));
            if (righeSelezionate.length === 0) {
                alert("Seleziona almeno una voce da cancellare.");
                return;
            }
            if (confirm(`Sei sicuro di voler cancellare ${righeSelezionate.length} voci? Questa azione non può essere annullata!`)) {
                const indiciDaCancellare = righeSelezionate.map((checkbox) => parseInt(checkbox.dataset.originalIndex, 10)).filter((index) => !isNaN(index));
                indiciDaCancellare.sort((a, b) => b - a);
                indiciDaCancellare.forEach((index) => {
                    storicoDati.splice(index, 1);
                });
                salvaDatiOnline();
                ricaricaTabellaPrincipale();
                aggiornaRiepilogo();
                pulisciRisultati();
                alert(`${indiciDaCancellare.length} voci sono state cancellate con successo.`);
            }
        }
        function pulisciRisultati() {
            document.getElementById("search-week-date").value = "";
            document.getElementById("search-month").value = "";
            document.getElementById("risultati-ricerca").style.display = "none";
        }
    </script>
</body>
</html>
