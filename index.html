<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Gestione Spese Pro - Locale</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-dark: #1e1e1e; --bg-light: #ffffff;
            --text-dark: #f5f5f5; --text-light: #222222;
            --accent: #4CAF50; --danger: #f44336;
            --warning: #FFC107; --info: #2196F3;
            --purple: #9C27B0; --secondary: #757575;
        }
        body { font-family: 'Segoe UI', Arial, sans-serif; background-color: var(--bg-dark); color: var(--text-dark); margin: 0; padding: 0; transition: 0.3s; }
        body.light-theme { background-color: var(--bg-light); color: var(--text-light); }
        header { padding: 20px; text-align: center; font-size: 1.8rem; font-weight: bold; background: rgba(0,0,0,0.2); }
        .container { width: 95%; max-width: 1200px; margin: 20px auto; padding-bottom: 100px; }
        .card { background: rgba(255,255,255,0.05); padding: 20px; border-radius: 12px; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); }
        .light-theme .card { background: #fff; border: 1px solid #ddd; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 15px; align-items: flex-end; }
        label { display: block; margin-bottom: 5px; font-size: 0.9rem; opacity: 0.8; }
        input, select { padding: 10px; border-radius: 6px; border: 1px solid #444; background: #2d2d2d; color: white; width: 100%; box-sizing: border-box; }
        .light-theme input, .light-theme select { background: #fff; color: #333; border: 1px solid #ccc; }
        button { padding: 10px 18px; border: none; border-radius: 6px; cursor: pointer; display: flex; align-items: center; gap: 8px; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; transform: translateY(-1px); }
        .accent { background: var(--accent); color: white; }
        .info { background: var(--info); color: white; }
        .danger { background: var(--danger); color: white; }
        .warning { background: var(--warning); color: #222; }
        .purple { background: var(--purple); color: white; }
        .secondary { background: var(--secondary); color: white; }
        .summary-box { display: flex; flex-wrap: wrap; gap: 25px; padding: 15px; font-size: 1.1rem; }
        .green { color: var(--accent); font-weight: bold; }
        .red { color: var(--danger); font-weight: bold; }
        .table-scroll { overflow-x: auto; margin-top: 15px; border-radius: 8px; }
        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th, td { padding: 12px; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.1); }
        .light-theme td, .light-theme th { border-bottom: 1px solid #eee; }
        .theme-toggle { position: absolute; top: 20px; right: 20px; }
        hr { border: 0; border-top: 1px solid rgba(255,255,255,0.1); margin: 30px 0; }
        #file-input { display: none; }
    </style>
</head>
<body onload="inizializza()">
    <header>Gestione Spese Auto</header>
    <button class="theme-toggle warning" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i> Tema</button>

    <div class="container">
        <div class="card">
            <div class="form-grid">
                <div><label>Data</label><input type="date" id="data"></div>
                <div><label>Entrate (€)</label><input type="number" id="entrate" value="0" step="0.01"></div>
                <div><label>Uscite (€)</label><input type="number" id="uscite" value="0" step="0.01"></div>
                <div>
                    <label>Nota</label>
                    <select id="note-select" onchange="checkAltro()">
                        <option value="">Seleziona...</option>
                        <option value="Ferma">Ferma</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Pedaggio Autostradale">Pedaggio Autostradale</option>
                        <option value="Canone Telepass">Canone Telepass</option>
                        <option value="Altro">Altro</option>
                    </select>
                    <input type="text" id="altra-nota" style="display:none; margin-top:5px" placeholder="Specifica...">
                </div>
                <button class="accent" onclick="aggiungiRecord()"><i class="fa-solid fa-plus"></i> Aggiungi</button>
            </div>
        </div>

        <div class="button-group" style="display:flex; flex-wrap: wrap; gap:10px; margin-bottom:20px;">
            <button class="purple" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-file-import"></i> Importa Backup (JSON)</button>
            <button class="info" onclick="esportaBackupJSON()"><i class="fa-solid fa-file-export"></i> Salva Backup (JSON)</button>
            <input type="file" id="file-input" accept=".json" onchange="importaBackupJSON(event)">
        </div>

        <div class="card summary-box">
            <div id="sum-entrate-main">Entrate: <span class="green">0.00 €</span></div>
            <div id="sum-uscite-main">Uscite: <span class="red">0.00 €</span></div>
            <div id="sum-fondo-main">Fondo: <strong>0.00 €</strong></div>
        </div>

        <button class="warning" onclick="toggleVisibilita('storico-container')"><i class="fa-solid fa-list"></i> Mostra/Nascondi Storico Completo</button>
        <div id="storico-container" style="display:none" class="table-scroll card">
            <table id="storico-table">
                <thead><tr><th>Data</th><th>Entrate</th><th>Uscite</th><th>Note</th><th>Azioni</th></tr></thead>
                <tbody></tbody>
            </table>
        </div>

        <hr>

        <h3><i class="fa-solid fa-search"></i> Filtri e Report PDF</h3>
        <div class="card">
            <div class="form-grid">
                <div><label>Settimana</label><input type="date" id="search-week"></div>
                <div><label>Mese (MM/YYYY)</label><input type="text" id="search-month" placeholder="01/2026"></div>
                <div><label>Periodo 15 - 16 succ. (MM/YYYY)</label><input type="text" id="search-15-16" placeholder="01/2026"></div>
            </div>
            <div style="display:flex; flex-wrap:wrap; gap:10px; margin-top:20px;">
                <button class="info" onclick="eseguiRicerca('week')">Filtra Settimana</button>
                <button class="info" onclick="eseguiRicerca('month')">Filtra Mese</button>
                <button class="info" onclick="eseguiRicerca('15-16')">Filtra 15-16 Succ.</button>
                <button class="secondary" onclick="resetFiltri()"><i class="fa-solid fa-rotate-left"></i> Reset Filtri</button>
                <button class="danger" onclick="generaPDF()"><i class="fa-solid fa-file-pdf"></i> Esporta Risultati in PDF</button>
            </div>
        </div>

        <div id="risultati-container" style="display:none" class="card">
            <h4 id="titolo-ricerca">Risultati</h4>
            <div class="table-scroll">
                <table id="search-table">
                    <thead><tr><th>Data</th><th>Entrate</th><th>Uscite</th><th>Note</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div class="summary-box" id="search-summary" style="background: rgba(0,0,0,0.1); border-radius: 8px; margin-top: 15px;"></div>
        </div>
    </div>

    <script>
        let databaseLocale = JSON.parse(localStorage.getItem('db_spese_locale')) || [];
        let datiFiltrati = [];
        let etichettaFiltro = "";
        let saldoPrecedente = 0;

        function inizializza() {
            const oggi = new Date();
            document.getElementById("data").valueAsDate = oggi;
            document.getElementById("search-week").valueAsDate = oggi;
            aggiornaTabella();
        }

        function salvaEAggiorna() {
            localStorage.setItem('db_spese_locale', JSON.stringify(databaseLocale));
            aggiornaTabella();
        }

        function aggiungiRecord() {
            const data = document.getElementById("data").value;
            const entrate = parseFloat(document.getElementById("entrate").value) || 0;
            const uscite = parseFloat(document.getElementById("uscite").value) || 0;
            const noteSel = document.getElementById("note-select").value;
            const notaFinale = noteSel === "Altro" ? document.getElementById("altra-nota").value : noteSel;

            if(!data) return alert("Inserisci la data!");

            const isFerma = noteSel === "Ferma";
            const haImporto = (entrate > 0 || uscite > 0);

            if (!isFerma && !haImporto) {
                return alert("Attenzione: Inserisci un importo oppure seleziona la nota 'Ferma'.");
            }

            databaseLocale.push({ id: Date.now(), data, entrate, uscite, note: notaFinale || "-" });
            salvaEAggiorna();
            resetForm();
        }

        function aggiornaTabella() {
            const tbody = document.querySelector("#storico-table tbody");
            tbody.innerHTML = "";
            let eT = 0, uT = 0;
            databaseLocale.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(item => {
                eT += item.entrate; uT += item.uscite;
                const row = tbody.insertRow();
                row.innerHTML = `<td>${item.data.split('-').reverse().join('/')}</td><td class="green">${item.entrate.toFixed(2)} €</td><td class="red">${item.uscite.toFixed(2)} €</td><td>${item.note}</td><td><button class="danger" onclick="elimina(${item.id})"><i class="fa-solid fa-trash"></i></button></td>`;
            });
            document.getElementById("sum-entrate-main").innerHTML = `Entrate: <span class="green">${eT.toFixed(2)} €</span>`;
            document.getElementById("sum-uscite-main").innerHTML = `Uscite: <span class="red">${uT.toFixed(2)} €</span>`;
            document.getElementById("sum-fondo-main").innerHTML = `Fondo: <strong>${(eT - uT).toFixed(2)} €</strong>`;
        }

        function elimina(id) { if(confirm("Eliminare voce?")) { databaseLocale = databaseLocale.filter(d => d.id !== id); salvaEAggiorna(); } }

        function esportaBackupJSON() {
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(databaseLocale, null, 2));
            const dl = document.createElement('a'); dl.setAttribute("href", dataStr); dl.setAttribute("download", "backup_spese.json"); dl.click();
        }

        function importaBackupJSON(event) {
            const file = event.target.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                try { const dati = JSON.parse(e.target.result); if(confirm(`Importare ${dati.length} voci?`)) { databaseLocale = dati; salvaEAggiorna(); } } catch(err) { alert("File JSON non valido."); }
            };
            reader.readAsText(file);
        }

        function calcolaSaldoPrecedente(dataInizioStr) {
            const inizioFiltro = new Date(dataInizioStr);
            return databaseLocale
                .filter(item => new Date(item.data) < inizioFiltro)
                .reduce((acc, item) => acc + (item.entrate - item.uscite), 0);
        }

        function eseguiRicerca(tipo) {
            const sw = document.getElementById("search-week").value;
            const sm = document.getElementById("search-month").value;
            const sp = document.getElementById("search-15-16").value;
            let dataInizioFiltro = "";

            if(tipo === 'week' && sw) {
                const d = new Date(sw);
                const day = d.getDay() || 7;
                const lun = new Date(d); lun.setDate(d.getDate() - day + 1);
                const dom = new Date(lun); dom.setDate(lun.getDate() + 6);
                dataInizioFiltro = lun.toISOString().split('T')[0];
                datiFiltrati = databaseLocale.filter(x => new Date(x.data) >= lun && new Date(x.data) <= dom);
                etichettaFiltro = `Settimana ${lun.toLocaleDateString()} - ${dom.toLocaleDateString()}`;
            } else if(tipo === 'month' && sm) {
                const parts = sm.split("/");
                if(parts.length < 2) return alert("Usa formato MM/YYYY");
                dataInizioFiltro = `${parts[1]}-${parts[0]}-01`;
                datiFiltrati = databaseLocale.filter(x => (new Date(x.data).getMonth()+1) == parts[0] && new Date(x.data).getFullYear() == parts[1]);
                etichettaFiltro = `Mese ${sm}`;
            } else if(tipo === '15-16' && sp) {
                const parts = sp.split("/");
                if(parts.length < 2) return alert("Usa formato MM/YYYY");
                
                const mesePartenza = parseInt(parts[0]) - 1;
                const annoPartenza = parseInt(parts[1]);

                // Dal 15 del mese scelto al 16 del mese successivo
                const inizio = new Date(annoPartenza, mesePartenza, 15);
                const fine = new Date(annoPartenza, mesePartenza + 1, 16);

                dataInizioFiltro = inizio.toISOString().split('T')[0];
                datiFiltrati = databaseLocale.filter(x => {
                    const d = new Date(x.data);
                    return d >= inizio && d <= fine;
                });
                
                const dataFineLabel = fine.toLocaleDateString('it-IT', {day:'2-digit', month:'2-digit', year:'numeric'});
                etichettaFiltro = `Periodo dal 15/${parts[0]}/${parts[1]} al ${dataFineLabel}`;
            }
            
            saldoPrecedente = calcolaSaldoPrecedente(dataInizioFiltro);
            mostraRisultati(datiFiltrati);
        }

        function mostraRisultati(dati) {
            datiFiltrati = dati.sort((a,b) => new Date(a.data) - new Date(b.data));
            const tbody = document.querySelector("#search-table tbody");
            tbody.innerHTML = "";
            let e = 0, u = 0;
            datiFiltrati.forEach(item => {
                e += item.entrate; u += item.uscite;
                tbody.innerHTML += `<tr><td>${item.data.split('-').reverse().join('/')}</td><td class="green">${item.entrate.toFixed(2)} €</td><td class="red">${item.uscite.toFixed(2)} €</td><td>${item.note}</td></tr>`;
            });
            const saldoPeriodo = e - u;
            const fondoCassaTotale = saldoPrecedente + saldoPeriodo;
            document.getElementById("titolo-ricerca").innerText = etichettaFiltro;
            document.getElementById("search-summary").innerHTML = `
                <div>Saldo Prec.: <span class="green">${saldoPrecedente.toFixed(2)} €</span></div>
                <div>Entrate: <span class="green">${e.toFixed(2)} €</span></div>
                <div>Uscite: <span class="red">${u.toFixed(2)} €</span></div>
                <div style="border-left: 2px solid #666; padding-left: 15px;">
                    FONDO TOTALE: <span class="green" style="font-size: 1.2rem;">${fondoCassaTotale.toFixed(2)} €</span>
                </div>
            `;
            document.getElementById("risultati-container").style.display = "block";
            document.getElementById("risultati-container").scrollIntoView({behavior: "smooth"});
        }

        function resetFiltri() {
            document.getElementById("search-week").valueAsDate = new Date();
            document.getElementById("search-month").value = "";
            document.getElementById("search-15-16").value = "";
            document.getElementById("risultati-container").style.display = "none";
            datiFiltrati = []; saldoPrecedente = 0;
        }

        function generaPDF() {
            if(datiFiltrati.length === 0) return alert("Nessun dato!");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF('p', 'mm', 'a4');
            doc.setFontSize(18); doc.text("REPORT SPESE", 14, 20);
            doc.setFontSize(10); doc.setTextColor(100); doc.text(etichettaFiltro, 14, 27);

            const body = datiFiltrati.map(i => [i.data.split('-').reverse().join('/'), i.entrate.toFixed(2) + " €", i.uscite.toFixed(2) + " €", i.note]);

            doc.autoTable({
                head: [['Data', 'Entrate (€)', 'Uscite (€)', 'Note']], body: body, startY: 35, theme: 'grid',
                headStyles: { fillColor: [44, 62, 80], halign: 'center' },
                columnStyles: { 1: { halign: 'right' }, 2: { halign: 'right' } },
                didParseCell: (data) => { if (data.section === 'body' && (data.column.index === 1 || data.column.index === 2)) data.cell.styles.textColor = [255, 255, 255]; },
                didDrawCell: (data) => {
                    if (data.section === 'body') {
                        const cellText = data.cell.text[0]; const val = parseFloat(data.cell.raw);
                        const xPos = data.cell.x + data.cell.width - 3; const yPos = data.cell.y + (data.cell.height / 2) + 1.5;
                        if (data.column.index === 1 && val > 0) { doc.setTextColor(46, 125, 50); doc.text(cellText, xPos, yPos, { align: 'right' }); }
                        else if (data.column.index === 2 && val > 0) { doc.setTextColor(211, 47, 47); doc.text(cellText, xPos, yPos, { align: 'right' }); }
                        else if ((data.column.index === 1 || data.column.index === 2) && val === 0) { doc.setTextColor(150); doc.text(cellText, xPos, yPos, { align: 'right' }); }
                    }
                }
            });

            const finalY = doc.lastAutoTable.finalY + 15;
            const eT = datiFiltrati.reduce((a,b) => a + b.entrate, 0);
            const uT = datiFiltrati.reduce((a,b) => a + b.uscite, 0);
            const totale = saldoPrecedente + (eT - uT);

            doc.setFontSize(9);
            doc.setTextColor(46, 125, 50); doc.text(`SALDO PREC: ${saldoPrecedente.toFixed(2)} €`, 14, finalY);
            doc.text(`ENTRATE: ${eT.toFixed(2)} €`, 60, finalY);
            doc.setTextColor(211, 47, 47); doc.text(`USCITE: ${uT.toFixed(2)} €`, 100, finalY);
            doc.setFont(undefined, 'bold'); doc.setTextColor(46, 125, 50); doc.text(`FONDO TOTALE: ${totale.toFixed(2)} €`, 145, finalY);

            doc.save(`Report_${etichettaFiltro.replace(/[/ ]/g, '_')}.pdf`);
        }

        function checkAltro() { document.getElementById("altra-nota").style.display = document.getElementById("note-select").value === "Altro" ? "block" : "none"; }
        function toggleVisibilita(id) { const el = document.getElementById(id); el.style.display = el.style.display === "none" ? "block" : "none"; }
        function toggleTheme() { document.body.classList.toggle("light-theme"); }
        function resetForm() { document.getElementById("entrate").value = 0; document.getElementById("uscite").value = 0; document.getElementById("note-select").value = ""; document.getElementById("altra-nota").style.display = "none"; }
    </script>
</body>
</html>
