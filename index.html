<!DOCTYPE html>
<html lang="it">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
    <title>Gestione Spese Auto Pro</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.29/jspdf.plugin.autotable.min.js"></script>
    <style>
        :root {
            --bg-dark: #121212; --bg-light: #f4f7f6;
            --card-dark: #1e1e1e; --card-light: #ffffff;
            --text-dark: #e0e0e0; --text-light: #2c3e50;
            --accent: #4CAF50; --danger: #e74c3c;
            --warning: #f1c40f; --info: #3498db;
            --purple: #9b59b6; --secondary: #95a5a6;
        }

        body { font-family: 'Inter', system-ui, sans-serif; background-color: var(--bg-dark); color: var(--text-dark); margin: 0; padding: 0; transition: 0.3s ease; }
        body.light-theme { background-color: var(--bg-light); color: var(--text-light); }

        header { position: relative; padding: 20px; text-align: center; font-size: 1.5rem; font-weight: 800; background: #1a1a1a; box-shadow: 0 2px 15px rgba(0,0,0,0.4); }
        .light-theme header { background: #ffffff; color: #333; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }

        .theme-toggle { position: absolute; top: 18px; right: 18px; width: 35px; height: 35px; border-radius: 50%; border: none; cursor: pointer; display: flex; align-items: center; justify-content: center; background: var(--warning); color: #222; }

        .container { width: 95%; max-width: 1200px; margin: 20px auto; display: flex; flex-direction: column; gap: 20px; }

        .card { background: var(--card-dark); padding: 20px; border-radius: 12px; border: 1px solid rgba(255,255,255,0.05); box-shadow: 0 4px 6px rgba(0,0,0,0.1); }
        .light-theme .card { background: var(--card-light); border: 1px solid #ddd; }

        .grid-main-form { display: grid; grid-template-columns: 1fr; gap: 15px; }
        @media (min-width: 992px) { .grid-main-form { grid-template-columns: 1.2fr 0.8fr 0.8fr 1fr 1fr 0.6fr 0.6fr; align-items: flex-end; } }

        label { display: block; margin-bottom: 6px; font-size: 0.7rem; font-weight: 700; text-transform: uppercase; opacity: 0.6; }
        input, select { height: 45px; padding: 0 12px; border-radius: 8px; border: 1.5px solid #333; background: #2d2d2d; color: white; width: 100%; font-size: 0.95rem; box-sizing: border-box; }
        .light-theme input, .light-theme select { background: #fff; color: #333; border: 1.5px solid #cbd5e0; }

        /* --- TASTI --- */
        .btn { height: 45px; border: none; border-radius: 8px; cursor: pointer; display: inline-flex; align-items: center; justify-content: center; gap: 8px; font-weight: 700; font-size: 0.85rem; transition: 0.2s; width: 100%; text-transform: uppercase; }
        
        @media (max-width: 767px) {
            .btn { height: 38px; font-size: 0.65rem; padding: 0 5px; gap: 4px; }
            /* Spaziatura tra i bottoni della ricerca */
            .filter-actions { flex-direction: column; gap: 12px !important; }
        }

        .btn-accent { background: var(--accent); color: white; }
        .btn-info { background: var(--info); color: white; }
        .btn-danger { background: var(--danger); color: white; }
        .btn-secondary { background: var(--secondary); color: white; }
        .btn-purple { background: var(--purple); color: white; }
        
        /* --- RIEPILOGO SU UNA RIGA --- */
        .summary-container { 
            display: grid; 
            grid-template-columns: repeat(3, 1fr); 
            gap: 8px; 
        }
        .summary-card { padding: 10px 5px; border-radius: 10px; text-align: center; background: rgba(255,255,255,0.03); }
        .summary-card label { font-size: 0.55rem; }
        .val { display: block; font-size: 0.85rem; font-weight: 800; margin-top: 5px; }

        @media (min-width: 768px) {
            .summary-card { padding: 15px; }
            .summary-card label { font-size: 0.7rem; }
            .val { font-size: 1.2rem; }
        }

        .table-wrapper { overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th { background: rgba(0,0,0,0.3); padding: 12px; text-align: left; font-size: 0.7rem; text-transform: uppercase; }
        td { padding: 12px; border-bottom: 1px solid rgba(255,255,255,0.05); }
        
        .green { color: var(--accent); }
        .red { color: var(--danger); }
        .blue { color: var(--info); }

        .action-btns { display: flex; gap: 15px; font-size: 1.1rem; }
        .action-btns i { cursor: pointer; }

        .grid-filters { display: grid; grid-template-columns: 1fr; gap: 15px; align-items: flex-end; }
        @media (min-width: 768px) { 
            .grid-filters { grid-template-columns: repeat(3, 1fr); } 
            .filter-actions { grid-column: 1 / -1; display: flex; gap: 10px; } 
        }

        .report-summary-box {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            background: rgba(0,0,0,0.2);
            border: 1px dashed var(--secondary);
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }
    </style>
</head>
<body onload="inizializza()">

    <header>
          <p style="font-size: 25px;">Gestione Spese Auto Lavoro</p>
<span style="font-size: 50%;"

        <button class="theme-toggle" onclick="toggleTheme()"><i class="fa-solid fa-circle-half-stroke"></i></button>
    </header>

    <div class="container">
        <div class="card">
            <input type="hidden" id="edit-id" value="">
            <div class="grid-main-form">
                <div><label>Data</label><input type="date" id="data"></div>
                <div><label>Entrata (€)</label><input type="number" id="entrate" step="0.01" placeholder="0.00"></div>
                <div><label>Uscita (€)</label><input type="number" id="uscite" step="0.01" placeholder="0.00"></div>
                <div>
                    <label>Nota</label>
                    <select id="note-select" onchange="checkAltro()">
                        <option value="">Seleziona...</option>
                        <option value="Ferma">Ferma</option>
                        <option value="Diesel">Diesel</option>
                        <option value="Pedaggio">Pedaggio</option>
                        <option value="Telepass">Telepass</option>
                        <option value="Altro">Altro...</option>
                    </select>
                </div>
                <div><button id="btn-submit" class="btn btn-accent" onclick="aggiungiRecord()"><i class="fa-solid fa-plus"></i> AGGIUNGI</button></div>
                <div><button class="btn btn-purple" onclick="document.getElementById('file-input').click()"><i class="fa-solid fa-upload"></i> IMPORTA</button></div>
                <div><button class="btn btn-purple" onclick="esportaBackupJSON()"><i class="fa-solid fa-download"></i> BACKUP</button></div>
                <div id="box-altra-nota" style="display:none; grid-column: span 2;"><label>Specifica Nota</label><input type="text" id="altra-nota"></div>
                <input type="file" id="file-input" style="display:none" accept=".json" onchange="importaBackupJSON(event)">
            </div>
        </div>

        <div class="summary-container">
            <div class="card summary-card"><label>Entrate</label><span class="val green" id="sum-entrate-main">0.00 €</span></div>
            <div class="card summary-card"><label>Uscite</label><span class="val red" id="sum-uscite-main">0.00 €</span></div>
            <div class="card summary-card" style="border-top: 2px solid var(--info)"><label>Fondo</label><span class="val" id="sum-fondo-main">0.00 €</span></div>
        </div>

        <button class="btn btn-secondary" onclick="toggleVisibilita('storico-container')"><i class="fa-solid fa-clock-rotate-left"></i> MOSTRA STORICO</button>
        
        <div id="storico-container" style="display:none" class="card">
            <div class="table-wrapper">
                <table id="storico-table">
                    <thead><tr><th>Data</th><th>E</th><th>U</th><th>Nota</th><th></th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
        </div>

        <div class="card">
            <label><i class="fa-solid fa-magnifying-glass"></i> Ricerca e Report</label>
            <div class="grid-filters">
                <div><label>Settimana</label><input type="date" id="search-week"></div>
                <div><label>Mese</label><input type="text" id="search-month" placeholder="MM/YYYY"></div>
                <div><label>15 - 16</label><input type="text" id="search-15-16" placeholder="MM/YYYY"></div>
                <div class="filter-actions" style="display: flex; gap: 10px;">
                    <button class="btn btn-info" onclick="eseguiRicerca('week')">SETTIMANA</button>
                    <button class="btn btn-info" onclick="eseguiRicerca('month')">MESE</button>
                    <button class="btn btn-info" onclick="eseguiRicerca('15-16')">15-16</button>
                    <button class="btn btn-danger" onclick="generaPDF()"><i class="fa-solid fa-file-pdf"></i> PDF</button>
                </div>
            </div>
        </div>

        <div id="risultati-container" style="display:none" class="card">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                <h4 id="titolo-ricerca" style="margin:0; font-size: 0.9rem; color:var(--info);"></h4>
                <button class="btn btn-secondary" style="width:auto; height:30px; padding:0 10px;" onclick="resetFiltri()">CHIUDI</button>
            </div>
            <div class="table-wrapper">
                <table id="search-table">
                    <thead><tr><th>Data</th><th>E</th><th>U</th><th>Nota</th></tr></thead>
                    <tbody></tbody>
                </table>
            </div>
            <div id="report-summary-display" class="report-summary-box"></div>
        </div>
    </div>

    <script>
        let databaseLocale = JSON.parse(localStorage.getItem('db_spese_locale')) || [];
        let datiFiltrati = [];
        let reportData = { saldoPrecedente: 0, entratePeriodo: 0, uscitePeriodo: 0, saldoFinale: 0, titolo: "" };

        function inizializza() { 
            const oggi = new Date().toISOString().split('T')[0];
            document.getElementById("data").value = oggi; 
            document.getElementById("search-week").value = oggi;
            aggiornaTabella(); 
        }

        function salvaEAggiorna() { localStorage.setItem('db_spese_locale', JSON.stringify(databaseLocale)); aggiornaTabella(); }

        function aggiungiRecord() {
            const idEdit = document.getElementById("edit-id").value;
            const d = document.getElementById("data").value;
            const e = parseFloat(document.getElementById("entrate").value) || 0;
            const u = parseFloat(document.getElementById("uscite").value) || 0;
            const n = document.getElementById("note-select").value;
            const nota = n === "Altro" ? document.getElementById("altra-nota").value : n;
            if(!d) return alert("Data mancante!");
            if(idEdit) {
                const i = databaseLocale.findIndex(x => x.id == idEdit);
                databaseLocale[i] = { ...databaseLocale[i], data: d, entrate: e, uscite: u, note: nota || "-" };
            } else {
                databaseLocale.push({ id: Date.now(), data: d, entrate: e, uscite: u, note: nota || "-" });
            }
            salvaEAggiorna(); resetForm();
        }

        function eseguiRicerca(tipo) {
            let inizio, fine;
            const valWeek = document.getElementById("search-week").value;
            const valMonth = document.getElementById("search-month").value;
            const val1516 = document.getElementById("search-15-16").value;

            if(tipo === 'week' && valWeek) {
                let d = new Date(valWeek);
                let day = d.getDay() || 7;
                inizio = new Date(d); inizio.setDate(d.getDate() - day + 1);
                fine = new Date(inizio); fine.setDate(inizio.getDate() + 6);
                reportData.titolo = "SETTIMANA DAL " + inizio.toLocaleDateString();
            } else if(tipo === 'month' && valMonth) {
                let p = valMonth.split("/");
                inizio = new Date(p[1], p[0]-1, 1);
                fine = new Date(p[1], p[0], 0);
                reportData.titolo = "MESE DI " + valMonth;
            } else if(tipo === '15-16' && val1516) {
                let p = val1516.split("/");
                inizio = new Date(p[1], p[0]-1, 15);
                fine = new Date(p[1], p[0], 16);
                reportData.titolo = "PERIODO 15-16 DI " + val1516;
            } else { return alert("Seleziona data!"); }

            reportData.saldoPrecedente = databaseLocale.filter(x => new Date(x.data) < inizio).reduce((acc, curr) => acc + (curr.entrate - curr.uscite), 0);
            
            datiFiltrati = databaseLocale.filter(x => {
                let d = new Date(x.data);
                return d >= inizio && d <= fine;
            }).sort((a,b) => new Date(a.data) - new Date(b.data));

            reportData.entratePeriodo = datiFiltrati.reduce((a,b) => a + b.entrate, 0);
            reportData.uscitePeriodo = datiFiltrati.reduce((a,b) => a + b.uscite, 0);
            reportData.saldoFinale = reportData.saldoPrecedente + reportData.entratePeriodo - reportData.uscitePeriodo;

            mostraRisultatiRicerca();
        }

        function mostraRisultatiRicerca() {
            const tbody = document.querySelector("#search-table tbody");
            tbody.innerHTML = "";
            datiFiltrati.forEach(i => {
                tbody.innerHTML += `<tr><td>${i.data.split('-').reverse().slice(0,2).join('/')}</td><td class="green">${i.entrate.toFixed(2)}</td><td class="red">${i.uscite.toFixed(2)}</td><td>${i.note}</td></tr>`;
            });

            document.getElementById("report-summary-display").innerHTML = `
                <div><label>Fondo Prec.</label><span>${reportData.saldoPrecedente.toFixed(2)} €</span></div>
                <div><label>Entrate/Uscite</label><span class="green">+${reportData.entratePeriodo.toFixed(2)}</span> / <span class="red">-${reportData.uscitePeriodo.toFixed(2)}</span></div>
                <div style="font-weight:bold"><label>Fondo Finale</label><span class="blue">${reportData.saldoFinale.toFixed(2)} €</span></div>
            `;
            document.getElementById("titolo-ricerca").innerText = reportData.titolo;
            document.getElementById("risultati-container").style.display = "block";
        }

        function generaPDF() {
            if(datiFiltrati.length === 0) return alert("Esegui prima una ricerca!");
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18); doc.text("REPORT SPESE AUTO", 14, 15);
            doc.setFontSize(11); doc.text(reportData.titolo, 14, 22);

            const rows = datiFiltrati.map(i => [i.data.split('-').reverse().join('/'), i.entrate.toFixed(2), i.uscite.toFixed(2), i.note]);
            doc.autoTable({
                head: [['Data', 'Entrata (€)', 'Uscita (€)', 'Nota']],
                body: rows,
                startY: 30,
                theme: 'grid',
                didParseCell: function(data) {
                    if (data.section === 'body') {
                        if (data.column.index === 1) data.cell.styles.textColor = [76, 175, 80];
                        if (data.column.index === 2) data.cell.styles.textColor = [231, 76, 60];
                    }
                }
            });

            const finalY = doc.lastAutoTable.finalY + 10;
            doc.setTextColor(0);
            doc.text(`FONDO PRECEDENTE: ${reportData.saldoPrecedente.toFixed(2)} €`, 14, finalY);
            doc.setTextColor(76, 175, 80);
            doc.text(`ENTRATE PERIODO: +${reportData.entratePeriodo.toFixed(2)} €`, 14, finalY + 7);
            doc.setTextColor(231, 76, 60);
            doc.text(`USCITE PERIODO: -${reportData.uscitePeriodo.toFixed(2)} €`, 14, finalY + 14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(52, 152, 219);
            doc.text(`FONDO CASSA ATTUALE: ${reportData.saldoFinale.toFixed(2)} €`, 14, finalY + 24);
            doc.save(`Report_${reportData.titolo}.pdf`);
        }

        function aggiornaTabella() {
            const tbody = document.querySelector("#storico-table tbody");
            tbody.innerHTML = "";
            let eT = 0, uT = 0;
            databaseLocale.sort((a,b) => new Date(b.data) - new Date(a.data)).forEach(item => {
                eT += item.entrate; uT += item.uscite;
                tbody.innerHTML += `<tr><td>${item.data.split('-').reverse().join('/')}</td><td class="green">${item.entrate.toFixed(2)}</td><td class="red">${item.uscite.toFixed(2)}</td><td>${item.note}</td>
                <td class="action-btns"><i class="fa-solid fa-pen blue" onclick="preparaModifica(${item.id})"></i> <i class="fa-solid fa-trash red" onclick="elimina(${item.id})"></i></td></tr>`;
            });
            document.getElementById("sum-entrate-main").innerText = eT.toFixed(2) + " €";
            document.getElementById("sum-uscite-main").innerText = uT.toFixed(2) + " €";
            document.getElementById("sum-fondo-main").innerText = (eT - uT).toFixed(2) + " €";
        }

        function preparaModifica(id) {
            const item = databaseLocale.find(x => x.id == id);
            document.getElementById("edit-id").value = item.id;
            document.getElementById("data").value = item.data;
            document.getElementById("entrate").value = item.entrate;
            document.getElementById("uscite").value = item.uscite;
            document.getElementById("btn-submit").innerHTML = '<i class="fa-solid fa-check"></i> OK';
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function elimina(id) { if(confirm("Eliminare?")) { databaseLocale = databaseLocale.filter(d => d.id !== id); salvaEAggiorna(); } }
        function resetForm() { document.getElementById("edit-id").value = ""; document.getElementById("entrate").value = ""; document.getElementById("uscite").value = ""; document.getElementById("btn-submit").innerHTML = '<i class="fa-solid fa-plus"></i> AGGIUNGI'; }
        function toggleVisibilita(id) { let e = document.getElementById(id); e.style.display = e.style.display === "none" ? "block" : "none"; }
        function toggleTheme() { document.body.classList.toggle("light-theme"); }
        function checkAltro() { document.getElementById("box-altra-nota").style.display = document.getElementById("note-select").value === "Altro" ? "block" : "none"; }
        function resetFiltri() { document.getElementById("risultati-container").style.display = "none"; }
        function esportaBackupJSON() { const blob = new Blob([JSON.stringify(databaseLocale)], {type: "application/json"}); const a = document.createElement('a'); a.href = URL.createObjectURL(blob); a.download = "backup.json"; a.click(); }
        function importaBackupJSON(event) { const reader = new FileReader(); reader.onload = (e) => { databaseLocale = JSON.parse(e.target.result); salvaEAggiorna(); }; reader.readAsText(event.target.files[0]); }
    </script>
</body>
</html>


